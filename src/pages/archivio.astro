---
import Layout from '../layouts/Layout.astro';
import HeaderFixed from '../components/HeaderFixed.astro';
import '../assets/archivio.css';

const opereRaw = await import('../data/opere.json').then(m => m.default);

// Extract the earliest year from strings like "1959", "1959-1962", "1970–2013"
// @ts-ignore
const parseYearStart = (y) => {
  if (!y) return Number.POSITIVE_INFINITY;
  const matches = String(y).match(/\d{4}/g);
  if (!matches) return Number.POSITIVE_INFINITY;
  return Math.min(...matches.map(Number));
};

// Chronological order: oldest first; tie-break by artist name
const opere = [...opereRaw].sort((a, b) => {
  const ya = parseYearStart(a.year);
  const yb = parseYearStart(b.year);
  if (ya !== yb) return ya - yb;
  return (a.artist || '').localeCompare(b.artist || '', 'it', { sensitivity: 'base' });
});

const editorMap = {
  'trame visuali': { url: '/editor-griglie/', label: 'Editor Griglie' },
  'trame': { url: '/editor-griglie/', label: 'Editor Griglie' },
  'cinetismi luminosi': { url: '/editor-luce/', label: 'Editor Luce' },
  'spazi magnetici': { url: '/editor-crashclock/', label: 'Editor Crash Clock' },
  'strutture discretizzate': { url: '/editor-pixel/', label: 'Editor Pixel' },
  'dinamiche ottiche': { url: '/editor-rombi/', label: 'Editor Rombi' }
};

// @ts-ignore
const pickEditor = (opera) => {
  const keyRaw = opera.editorTitle || opera.editor || opera.generatorTitle;
  const key = keyRaw ? keyRaw.toString().trim().toLowerCase() : '';
  if (key && editorMap[key as keyof typeof editorMap]) {
    return editorMap[key as keyof typeof editorMap];
  }
  return { url: '/editor/', label: 'Editor generale' };
};
---
<head>
	<meta charset="UTF-8">
</head>
<Layout>
  <HeaderFixed currentPage="archivio" />

  <main class="archivio-page">
    <!-- Filter section -->
    <div class="filter-section">
      <div class="filter-buttons">
        <button class="filter-btn active" data-group="all">tutti</button>
        <button class="filter-btn" data-group="Gruppo T">gruppo T</button>
        <button class="filter-btn" data-group="Gruppo N">gruppo N</button>
      </div>
    </div>

    <div class="filter-spacer"></div>

    <!-- Left side: Rolodex 3D scroll -->
    <div class="rolodex-container">
      <div class="rolodex-viewport">
        <div id="rolodex" class="rolodex">
          <!-- Group description card (hidden by default, shown when filtering) -->
          <div class="card group-intro-card" data-index="-1" data-group="Gruppo T" style="display: none;">
            <div class="card-inner">
              <img src="/drive-opere/gruppo-t.webp" alt="Gruppo T" />
            </div>
          </div>
          <div class="card group-intro-card" data-index="-1" data-group="Gruppo N" style="display: none;">
            <div class="card-inner">
              <img src="/drive-opere/gruppo-n.png" alt="Gruppo N" />
            </div>
          </div>

          {opere.map((opera, index) => (
            <div class="card" data-index={index} data-id={opera.id} data-group={opera.group} data-image={opera.image} data-title={opera.title} data-artist={opera.artist} data-year={opera.year} data-technique={opera.technique} data-location={opera.location}>
              <div class="card-inner">
                <img
                  src={opera.image}
                  alt={`${opera.artist} — ${opera.title}`}
                />
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Right side: Details -->
    <div class="details-container">
      <div class="details-content" id="detailsContent">
        <!-- Group description details (hidden by default) -->
        <div class="opera-details group-intro-detail" data-index="-1" data-group="Gruppo T" style="display: none;">
          <div class="opera-header">
            <span class="opera-group">Gruppo T</span>
            <span class="opera-year">1959 – 1968</span>
          </div>
          <div class="group-intro-text">
            <blockquote>"Consideriamo quindi la realtà come continuo divenire di fenomeni che noi percepiamo nella variazione."</blockquote>
            <p>Il gruppo T, nasce nel 1961, attorno alle personalità di Giovanni Anceschi, Davide Boriani, Gianni Colombo, Gabriele Devecchi, e Grazia Varisco. Tutti i membri del Gruppo milanese, sono accomunati da un fortissimo senso di appartenenza al gruppo, e dalla medesima visione di un'arte specchio dei rapidi cambiamenti sociali.</p>
            <p>L'arte sconfina nel campo dalla scienza, e non può più prescindere dalla ricerca del dinamismo intrinseco alla realtà.</p>
            <p>Affianco al concetto di cinetismo emerge quello di continua trasformazione, tanto dei materiali quanto delle variabili spaziali.</p>
            <p>In questo contesto si inseriscono i Percorsi fluidi di Anceschi, stranianti e resi interattivi dalla rotazione e dallo spostamento manuale, o le Superfici magnetiche di Boriani, che, nella loro precisione scientifica, stimolano la sensorialità dello spettatore; allo stesso modo i pulsanti Schemi Luminosi Varabili di Grazia Varisco e gli URMNT, le lamiere forate di DeVecchi, che confermano uno studio avanzato sulle potenzialità dei materiali e si dimostrano esempi validissimi di soluzioni autonome, individuali, all'interno di una poetica comune.</p>
          </div>
        </div>

        <div class="opera-details group-intro-detail" data-index="-1" data-group="Gruppo N" style="display: none;">
          <div class="opera-header">
            <span class="opera-group">Gruppo N</span>
            <span class="opera-year">1959 – 1976</span>
          </div>
          <div class="group-intro-text">
            <blockquote>"La dicitura enne distingue un gruppo di "disegnatori sperimentali" uniti dall'esigenza di ricercare collettivamente".</blockquote>
            <p>Il nucleo originario del gruppo N si forma a Parma nel 1959; nel 1960 raggiunge il suo assetto definitivo con gli artisti Alberto Biasi, Ennio Chiggio, Toni Costa, Edoardo Landi e Manfredo Massironi.</p>
            <p>Il concetto di lavoro di gruppo diviene radicale e, di conseguenza, il rifiuto del principio di autorialità: l'intento è quello di intraprendere la via della globalità del fare artistico, mettendo in discussione l'immagine dell'artista come individualista elitario. L'intera opera del gruppo è intrisa di una forte componente etica e politica.</p>
            <p>Il Gruppo N diventa una sorta di laboratorio europeo della forma virtuale, che esplora tanto la bidimensionalità, nelle variazioni ottiche della superficie, quanto la spazialità e l'oggetto tridimensionale. Il fine ultimo si ritrova nel coinvolgimento dello spettatore, sfruttando e sfidando la psicologia della percezione.</p>
            <p>Questa è la poetica dei Rilievi ottico-dinamici e dei Light Prism di Alberto Biasi, delle Trame e delle Interferenze Lineari di Ennio Chiggio, delle Dinamiche Visuali di Toni Costa, delle Riflessioni sferiche di Edoardo Landi, delle Fotoriflessioni di Manfredo Massironi.</p>
          </div>
        </div>

        {opere.map((opera, index) => (
          <div class="opera-details" data-index={index} data-id={opera.id} data-group={opera.group}>
            <!-- Dati embedded nella card stessa -->
            <div class="opera-header">
              <span class="opera-group">{opera.group}</span>
              <span class="opera-year">{opera.year}</span>
            </div>
            <h2 class="opera-title">{opera.title}</h2>
            <p class="opera-artist">{opera.artist}</p>
            
            {opera.technique && (
              <div class="opera-info">
                <p class="opera-technique"> {opera.technique}</p>
              </div>
            )}
            
            

            {(() => {
              const editor = pickEditor(opera);
              return (
                <a class="editor-link-btn" href={editor.url} title={editor.label} aria-label={`Vai all'editor: ${editor.label}`}>
                  Vai all'editor
                </a>
              );
            })()}
          </div>
        ))}
      </div>
    </div>

    <!-- Scroll indicator -->
    <div class="scroll-indicator">
      <span>Scorri per ruotare</span>
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M10 5V15M10 15L6 11M10 15L14 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </main>

  <script>
    // @ts-nocheck
    // Rolodex-style 3D rotation controlled by scroll
    let rolodex = null;
    let cards = [];
    let detailsElements = [];
    let targetRotation = 0;
    let currentRotation = 0;
    let activeCardId = null;
    let cardCount = 0;
    let anglePerCard = 0;
    let activeGroup = 'all';
    let filteredCards = [];
    let filteredDetails = [];
    let groupIntroCards = [];
    let groupIntroDetails = [];
    let pageEl = null;

    // Helper: parse earliest year from strings like "1959", "1959-1962", "1970–2013"
    function parseYearStartStr(y) {
      if (!y) return Number.POSITIVE_INFINITY;
      const matches = String(y).match(/\d{4}/g);
      if (!matches) return Number.POSITIVE_INFINITY;
      return Math.min(...matches.map(Number));
    }

    const BASE_CARD_WIDTH = 420;
    const MIN_CARD_HEIGHT = 280;
    const MAX_CARD_HEIGHT = 520;

    // Group descriptions
    const groupDescriptions = {
      'Gruppo T': `
        <div class="description-content">
          <blockquote>“Consideriamo quindi la realtà come continuo divenire di fenomeni che noi percepiamo nella variazione.”</blockquote>
          <p>Il gruppo T, nasce nel 1961, attorno alle personalità di Giovanni Anceschi, Davide Boriani, Gianni Colombo, Gabriele Devecchi, e Grazia Varisco. Tutti i membri del Gruppo milanese, sono accomunati da un fortissimo senso di appartenenza al gruppo, e dalla medesima visione di un’arte specchio dei rapidi cambiamenti sociali.</p>
          <p>L’arte sconfina nel campo dalla scienza, e non può più prescindere dalla ricerca del dinamismo intrinseco alla realtà.</p>
          <p>Affianco al concetto di cinetismo emerge quello di continua trasformazione, tanto dei materiali quanto delle variabili spaziali.</p>
          <p>In questo contesto si inseriscono i Percorsi fluidi di Anceschi, stranianti e resi interattivi dalla rotazione e dallo spostamento manuale, o le Superfici magnetiche di Boriani, che, nella loro precisione scientifica, stimolano la sensorialità dello spettatore; allo stesso modo i pulsanti Schemi Luminosi Varabili di Grazia Varisco e gli URMNT, le lamiere forate di DeVecchi, che confermano uno studio avanzato sulle potenzialità dei materiali e si dimostrano esempi validissimi di soluzioni autonome, individuali, all’interno di una poetica comune.</p>
        </div>
      `,
      'Gruppo N': `
        <div class="description-content">
          <blockquote>“La dicitura enne distingue un gruppo di “disegnatori sperimentali” uniti dall'esigenza di ricercare collettivamente”.</blockquote>
          <p>Il nucleo originario del gruppo N si forma a Parma nel 1959; nel 1960 raggiunge il suo assetto definitivo con gli artisti Alberto Biasi, Ennio Chiggio, Toni Costa, Edoardo Landi e Manfredo Massironi.</p>
          <p>Il concetto di lavoro di gruppo diviene radicale e, di conseguenza, il rifiuto del principio di autorialità: l’intento è quello di intraprendere la via della globalità del fare artistico, mettendo in discussione l’immagine dell’artista come individualista elitario. L’intera opera del gruppo è intrisa di una forte componente etica e politica.</p>
          <p>Il Gruppo N diventa una sorta di laboratorio europeo della forma virtuale, che esplora tanto la bidimensionalità, nelle variazioni ottiche della superficie, quanto la spazialità e l’oggetto tridimensionale. Il fine ultimo si ritrova nel coinvolgimento dello spettatore, sfruttando e sfidando la psicologia della percezione.</p>
          <p>Questa è la poetica dei Rilievi ottico-dinamici e dei Light Prism di Alberto Biasi, delle Trame e delle Interferenze Lineari di Ennio Chiggio, delle Dinamiche Visuali di Toni Costa, delle Riflessioni sferiche di Edoardo Landi, delle Fotoriflessioni di Manfredo Massironi.</p>
        </div>
      `
    };

    function updateStackHeights() {
      const filterSection = document.querySelector('.filter-section');
      const spacer = document.querySelector('.filter-spacer');

      const filterH = filterSection?.offsetHeight ?? 0;

      document.documentElement.style.setProperty('--filter-height', `${filterH}px`);
      if (spacer) {
        spacer.style.height = `${filterH}px`;
      }
    }

    function ensurePageHeight() {
      if (!pageEl) return;
      const cardsForHeight = Math.max(cardCount, 8);
      const targetVH = Math.max(1200, cardsForHeight * 25);
      pageEl.style.minHeight = `${targetVH}vh`;
    }

    function filterCards(group) {
      activeGroup = group;
      
      // Update button states
      const filterBtns = document.querySelectorAll('.filter-btn');
      filterBtns.forEach(btn => {
        if (btn.dataset.group === group) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Hide all group intro cards first
      groupIntroCards.forEach(card => {
        card.style.display = 'none';
      });
      groupIntroDetails.forEach(detail => {
        detail.style.display = 'none';
      });

      // Filter cards and details
      if (group === 'all') {
        // Sort all cards chronologically: oldest first
        filteredCards = [...cards].sort((a, b) => {
          const ya = parseYearStartStr(a.dataset.year);
          const yb = parseYearStartStr(b.dataset.year);
          if (ya !== yb) return ya - yb;
          return (a.dataset.artist || '').localeCompare(b.dataset.artist || '', 'it', { sensitivity: 'base' });
        });
        filteredDetails = detailsElements;
      } else {
        // Find and show the matching group intro card/detail
        const introCard = groupIntroCards.find(c => c.dataset.group === group);
          const introDetail = groupIntroDetails.find(d => d.dataset.group === group);
        
        if (introCard) introCard.style.display = 'block';
        if (introDetail) introDetail.style.display = 'block';

        // Build filtered lists with intro first
        // Filter and sort artwork cards chronologically within the group
        const artworkCardsUnsorted = cards.filter(card => card.dataset.group === group);
        const artworkCards = artworkCardsUnsorted.sort((a, b) => {
          const ya = parseYearStartStr(a.dataset.year);
          const yb = parseYearStartStr(b.dataset.year);
          if (ya !== yb) return ya - yb;
          return (a.dataset.artist || '').localeCompare(b.dataset.artist || '', 'it', { sensitivity: 'base' });
        });
          const artworkDetails = detailsElements.filter(detail => detail.dataset.group === group);
        
        filteredCards = introCard ? [introCard, ...artworkCards] : artworkCards;
          filteredDetails = introDetail ? [introDetail, ...artworkDetails] : artworkDetails;
        
        // Re-index filtered cards for correct positioning
        filteredCards.forEach((card, idx) => {
          card.dataset.filteredIndex = idx.toString();
        });
      }

      // Hide/show artwork cards
      cards.forEach(card => {
        if (group === 'all' || card.dataset.group === group) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });

      // Update card count and re-position
      cardCount = filteredCards.length;
      anglePerCard = 360 / cardCount;
      ensurePageHeight();

      // Re-position visible cards in 3D in filtered order
      filteredCards.forEach((card, index) => {
        const angle = anglePerCard * index;
        card.style.transform = `translateY(-50%) rotateX(${angle}deg) translateZ(600px)`;
        card.dataset.filteredIndex = index.toString();
      });

      // Reset rotation
      currentRotation = 0; 
      targetRotation = 0;
      window.scrollTo(0, 0);
      
        // Set active card id to the first filtered card (if any)
        activeCardId = filteredCards[0]?.dataset.id || null;
        updateCardsVisibility();
    }

    function init() {
      rolodex = document.getElementById('rolodex');
      if (!rolodex) return;
      pageEl = document.querySelector('.archivio-page');

      // Suppress image 404 errors in console
      const allImages = document.querySelectorAll('.card img');
      allImages.forEach(img => {
        img.onerror = () => {
          // Silently hide broken images
          img.style.opacity = '0.3';
          img.alt = 'Immagine non disponibile';
        };

        // Adapt card size to the image proportion
        const card = img.closest('.card');
        if (!card) return;
        const applySizeFromImage = () => {
          const { naturalWidth, naturalHeight } = img;
          const ratio = naturalWidth > 0 ? naturalHeight / naturalWidth : 1;
          const height = Math.min(MAX_CARD_HEIGHT, Math.max(MIN_CARD_HEIGHT, BASE_CARD_WIDTH * ratio));
          card.style.width = `${BASE_CARD_WIDTH}px`;
          card.style.height = `${height}px`;
        };

        if (img.complete && img.naturalWidth) {
          applySizeFromImage();
        } else {
          img.onload = () => {
            applySizeFromImage();
          };
        }
      });

      // Separate group intro cards from artwork cards
      const allCards = Array.from(document.querySelectorAll('.card'));
      groupIntroCards = allCards.filter(card => card.classList.contains('group-intro-card'));
      cards = allCards.filter(card => !card.classList.contains('group-intro-card'));
      
      const allDetails = Array.from(document.querySelectorAll('.opera-details'));
      groupIntroDetails = allDetails.filter(detail => detail.classList.contains('group-intro-detail'));
      detailsElements = allDetails.filter(detail => !detail.classList.contains('group-intro-detail'));
      
      filteredCards = cards;
      filteredDetails = detailsElements;
      
      cardCount = cards.length;
      anglePerCard = 360 / cardCount;
      ensurePageHeight();

      // Position cards in 3D space
      cards.forEach((card, index) => {
        const angle = anglePerCard * index;
        
        card.style.transformOrigin = 'center center';
        card.style.transform = `translateY(-50%) rotateX(${angle}deg) translateZ(600px)`;
      });

      // Show first card details based on visibility
      updateCardsVisibility();

      updateStackHeights();
      window.addEventListener('resize', updateStackHeights);

      // Setup filter buttons
      const filterBtns = document.querySelectorAll('.filter-btn');
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const group = btn.dataset.group || 'all';
          filterCards(group);
        });
      });

      // Handle scroll
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            handleScroll();
            ticking = false;
          });
          ticking = true;
        }
      });

      // Smooth animation loop
      animate();
    }

    function attachImageFallbacks() {
      const imgs = document.querySelectorAll('.card img[data-candidates]');
      imgs.forEach((img) => {
        const listRaw = img.dataset.candidates || '';
        const list = listRaw.split('|').filter(Boolean);
        let idx = 0;
        img.onerror = () => {
          idx += 1;
          if (idx < list.length) {
            img.src = list[idx];
          } else {
            img.style.display = 'none';
          }
        };
      });
    }

    function handleScroll() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollHeight = Math.max(
        document.documentElement.scrollHeight,
        document.body.scrollHeight,
        document.documentElement.offsetHeight,
        document.body.offsetHeight
      );
      const maxScroll = Math.max(scrollHeight - window.innerHeight, 1);
      const scrollProgress = Math.min(scrollTop / maxScroll, 1);

      targetRotation = -scrollProgress * 360 * ((cardCount - 1) / cardCount);
    }

    function animate() {
      const diff = targetRotation - currentRotation;
      currentRotation += diff * 0.1;

      if (rolodex) {
        rolodex.style.transform = `rotateX(${-currentRotation}deg)`;
      }

      updateCardsVisibility();
      requestAnimationFrame(() => animate());
    }

    function updateCardsVisibility() {
      let bestCard = null;
      let bestAbs = Infinity;

      filteredCards.forEach((card, index) => {
        const cardAngle = anglePerCard * index;
        const currentCardAngle = ((cardAngle - currentRotation) % 360 + 360) % 360;
        
        let normalizedAngle = currentCardAngle;
        if (normalizedAngle > 180) normalizedAngle -= 360;
        
        const absAngle = Math.abs(normalizedAngle);
        if (absAngle < bestAbs) {
          bestAbs = absAngle;
          bestCard = card;
        }
        
        let opacity;
        if (absAngle < anglePerCard * 0.4) {
          opacity = 1;
          card.style.zIndex = '100';
          card.style.pointerEvents = 'auto';
        } else {
          opacity = 0;
          card.style.zIndex = '0';
          card.style.pointerEvents = 'none';
        }
        
        card.style.opacity = opacity.toString();
        card.style.transition = 'opacity 0.25s ease';
      });

      // After setting visibility, show details for the front-most card
      if (bestCard) {
        if (bestCard.classList.contains('group-intro-card')) {
          const group = bestCard.dataset.group;
          activeCardId = null;
          updateGroupIntroDetail(group);
        } else {
          activeCardId = bestCard.dataset.id || null;
          updateActiveDetailsById(activeCardId);
        }
      }
    }

    function updateGroupIntroDetail(group) {
      // Hide all details first
      detailsElements.forEach((el) => {
        el.classList.remove('active');
      });
      groupIntroDetails.forEach((el) => {
        el.classList.remove('active');
      });

      if (!group) return;
      const introDetail = groupIntroDetails.find(d => d.dataset.group === group);
      if (introDetail) {
        introDetail.classList.add('active');
      }
    }

    function updateActiveDetailsById(cardId) {
      // Hide all details first
      detailsElements.forEach((el) => {
        el.classList.remove('active');
      });
      groupIntroDetails.forEach((el) => {
        el.classList.remove('active');
      });

      if (!cardId) return;

      // For artwork cards: find detail by matching data-id in the FULL list
      const matchingDetail = detailsElements.find(el => el.dataset.id === cardId);
      if (matchingDetail) {
        matchingDetail.classList.add('active');
        return;
      }
    }

    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</Layout>

