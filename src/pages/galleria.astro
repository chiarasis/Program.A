---
import Layout from '../layouts/Layout.astro';

// Seeded random for consistent generation (matches generate-gallery.js)
function mulberry32(a) {
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

// Generate random posters data from the 3 editors
const generateRandomPosters = (count) => {
  const random = mulberry32(12345); // Fixed seed for consistency
  const posters = [];
  const editors = ['poster', 'moire', 'kinetic'];
  const gridSpacing = 800;
  
  for (let i = 0; i < count; i++) {
    const editor = editors[Math.floor(random() * editors.length)];
    const seed = Math.floor(random() * 999999);
    
    // Random position in a loose grid with variance
    const gridX = (i % 8) * gridSpacing + (random() - 0.5) * 400;
    const gridY = Math.floor(i / 8) * gridSpacing + (random() - 0.5) * 400;
    
    posters.push({
      id: i,
      editor,
      seed,
      x: gridX,
      y: gridY,
      filename: `${editor}-${seed}.png`,
      url: `/editor-${editor}?seed=${seed}`,
      title: `${editor.charAt(0).toUpperCase() + editor.slice(1)} #${seed}`,
      date: new Date(2025, 0, Math.floor(random() * 30) + 1).toLocaleDateString('it-IT')
    });
  }
  
  return posters;
};

const posters = generateRandomPosters(15);
---

<Layout>
  <div slot="head">
    <script src="/js/infiniteGallery.js" defer></script>
  </div>

  <main class="infinite-gallery">
    <div class="gallery-ui">
      <div class="ui-top">
        <h1>LE VOSTRE OPERE</h1>
      </div>
      
      <div class="ui-controls">
        <button id="resetView" class="control-btn">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M10 4V1L6 5L10 9V6C12.76 6 15 8.24 15 11C15 11.65 14.87 12.26 14.64 12.83L15.96 14.15C16.63 13.21 17 12.15 17 11C17 7.13 13.87 4 10 4Z" fill="currentColor"/>
            <path d="M10 16C7.24 16 5 13.76 5 11C5 10.35 5.13 9.74 5.36 9.17L4.04 7.85C3.37 8.79 3 9.85 3 11C3 14.87 6.13 18 10 18V21L14 17L10 13V16Z" fill="currentColor"/>
          </svg>
          <span>Reset</span>
        </button>
        
        <button id="zoomIn" class="control-btn">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        
        <button id="zoomOut" class="control-btn">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="ui-info">
        <span id="posterCount">{posters.length} generazioni</span>
        <span id="position">X: 0, Y: 0</span>
      </div>
    </div>

    <div id="canvas" class="gallery-canvas">
      <div id="postersContainer" class="posters-container">
        {posters.map((poster) => (
          <div 
            class="poster-card" 
            data-id={poster.id}
            data-editor={poster.editor}
            data-seed={poster.seed}
            style={`left: ${poster.x}px; top: ${poster.y}px;`}
          >
            <div class="poster-preview">
              <img 
                src={`/gallery/${poster.filename}`}
                alt={poster.title}
                loading="lazy"
                class="poster-image"
              />
            </div>
            <div class="poster-info">
              <h3>{poster.title}</h3>
              <p>{poster.date}</p>
              <a href={poster.url} class="view-btn">Apri nell'editor →</a>
            </div>
          </div>
        ))}
      </div>
    </div>

    <div class="navigation-hint">
      <p>Trackpad: scorri per muoverti • Mouse: click e trascina • Doppio click per vista d'insieme</p>
    </div>
  </main>
</Layout>

<style>
  .infinite-gallery {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #0a0a0a;
    overflow: hidden;
    cursor: grab;
  }

  .infinite-gallery.dragging {
    cursor: grabbing;
  }

  .gallery-canvas {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  .posters-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transform-origin: 0 0;
    transition: transform 0.1s ease-out;
  }

  .poster-card {
    position: absolute;
    width: 300px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .poster-card:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
    z-index: 10;
  }

  .poster-preview {
    width: 100%;
    height: 450px;
    background: #1a1a1a;
    position: relative;
    overflow: hidden;
  }

  .poster-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .poster-info {
    padding: 20px;
    color: #fff;
  }

  .poster-info h3 {
    font-size: 1rem;
    font-weight: 300;
    margin-bottom: 8px;
    color: #fff;
  }

  .poster-info p {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 16px;
  }

  .view-btn {
    display: inline-block;
    color: #fff;
    text-decoration: none;
    font-size: 0.85rem;
    opacity: 0.7;
    transition: opacity 0.3s;
  }

  .view-btn:hover {
    opacity: 1;
  }

  .gallery-ui {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    pointer-events: none;
  }

  .ui-top {
    padding: 40px;
    text-align: center;
    color: #fff;
  }

  .ui-top h1 {
    font-size: 2rem;
    font-weight: 300;
    letter-spacing: 8px;
    margin-bottom: 8px;
  }

  .subtitle {
    font-size: 0.9rem;
    color: #666;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .ui-controls {
    position: fixed;
    top: 40px;
    right: 40px;
    display: flex;
    gap: 12px;
    pointer-events: auto;
  }

  .control-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 12px 16px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    transition: all 0.3s;
    font-family: inherit;
  }

  .control-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .ui-info {
    position: fixed;
    bottom: 40px;
    left: 40px;
    display: flex;
    gap: 24px;
    color: #666;
    font-size: 0.85rem;
    letter-spacing: 1px;
    pointer-events: none;
  }

  .navigation-hint {
    position: fixed;
    bottom: 40px;
    right: 40px;
    color: #666;
    font-size: 0.85rem;
    letter-spacing: 1px;
    text-align: right;
    pointer-events: none;
  }

  @media (max-width: 768px) {
    .ui-top {
      padding: 24px;
    }

    .ui-top h1 {
      font-size: 1.5rem;
      letter-spacing: 4px;
    }

    .ui-controls {
      top: 24px;
      right: 24px;
      flex-direction: column;
    }

    .control-btn span {
      display: none;
    }

    .ui-info,
    .navigation-hint {
      bottom: 24px;
      left: 24px;
      right: auto;
      font-size: 0.75rem;
    }

    .poster-card {
      width: 250px;
    }

    .poster-preview {
      height: 375px;
    }
  }
</style>
